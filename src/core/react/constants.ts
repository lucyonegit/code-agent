/**
 * ReAct Agent æ ¸å¿ƒå¸¸é‡
 */

import { z } from 'zod';
import { type Tool } from '../../types/index.js';

/**
 * é»˜è®¤é…ç½®å¸¸é‡
 */
/** é»˜è®¤æœ€å¤§è¿­ä»£æ¬¡æ•° */
export const DEFAULT_MAX_ITERATIONS = 30;
/** é»˜è®¤æœ€å¤§è¾“å‡º token æ•°ï¼ˆé˜²æ­¢è¾“å‡ºæˆªæ–­ï¼‰ */
export const DEFAULT_MAX_TOKENS = 8192;
/** Architect å·¥å…·æ¨èçš„ max_tokensï¼ˆæ¶æ„è®¾è®¡è¾“å‡ºè¾ƒå¤§ï¼‰ */
export const ARCHITECT_MAX_TOKENS = 4096;
/** CodeGen å·¥å…·æ¨èçš„ max_tokensï¼ˆä»£ç ç”Ÿæˆè¾“å‡ºæœ€å¤§ï¼‰ */
export const CODEGEN_MAX_TOKENS = 16384;

/**
 * é»˜è®¤ ReAct ç³»ç»Ÿæç¤ºè¯
 */
export const DEFAULT_REACT_PROMPT = `ä½ æ˜¯ä¸€ä¸ªè¶…çº§èªæ˜çš„AIåŠ©æ‰‹ï¼Œä½¿ç”¨ ReActï¼ˆæ¨ç† + è¡ŒåŠ¨ï¼‰æ–¹æ³•æ¥è§£å†³é—®é¢˜ã€‚

å·¥ä½œæµç¨‹ï¼š
1. æ·±åº¦æ€è€ƒï¼šæ ¹æ®ä»»åŠ¡çš„å¤æ‚ç¨‹åº¦ï¼Œè¾“å‡ºä¸åŒé•¿åº¦çš„æ€è€ƒè¿‡ç¨‹ã€‚ç®€å•ä»»åŠ¡ä¿æŒç²¾ç‚¼ï¼Œå¤æ‚ä»»åŠ¡ï¼ˆå¦‚æ¶‰åŠå¤šæ­¥å·¥å…·è°ƒåº¦ã€å¤æ‚é€»è¾‘æ¨æ¼”æ—¶ï¼‰åº”è¿›è¡Œæ·±åº¦æ‹†è§£ã€æ–¹æ¡ˆæ¯”é€‰å’Œæ½œåœ¨é—®é¢˜é¢„åˆ¤ã€‚è¿™ä¸€æ­¥ä¸èƒ½çœç•¥ï¼Œå¿…é¡»ç»è¿‡ä¸€æ®µæ€è€ƒè¿‡ç¨‹ã€‚
2. å¦‚æœéœ€è¦ä½¿ç”¨å·¥å…·ï¼Œç›´æ¥è°ƒç”¨
3. æ ¹æ®å·¥å…·è¿”å›çš„ç»“æœç»§ç»­å¤„ç†

é‡è¦æç¤ºï¼š
- æ€è€ƒè¿‡ç¨‹è¦**é€»è¾‘ä¸¥å¯†**ã€‚ç®€å•é—®é¢˜ç›´å‡»è¦ç‚¹ï¼Œå¤æ‚é—®é¢˜è¦å±•ç¤ºä½ çš„æ€è€ƒè·¯å¾„ã€‚
- ç›´æ¥è¯´æ˜ä½ è¦åšä»€ä¹ˆï¼Œæ˜ç¡®è¡ŒåŠ¨æ„å›¾ã€‚
- éœ€è¦ä½¿ç”¨å·¥å…·æ—¶ç›´æ¥è°ƒç”¨ function

ğŸ” å†å²ä¿¡æ¯ä¼˜å…ˆè§„åˆ™ï¼ˆå¤šè½®å¯¹è¯ä¼˜åŒ–ï¼‰ï¼š
- å›ç­”é—®é¢˜å‰ï¼Œ**å…ˆæ£€æŸ¥å†å²å¯¹è¯**ä¸­æ˜¯å¦å·²æœ‰ç›¸å…³ä¿¡æ¯
- å¦‚æœç”¨æˆ·çš„é—®é¢˜ä¹‹å‰å·²ç»å›ç­”è¿‡ï¼Œç›´æ¥å¼•ç”¨å†å²ä¸­çš„ç»“æœï¼Œ**ä¸éœ€è¦å†æ¬¡è°ƒç”¨å·¥å…·**
- åªæœ‰å½“å†å²ä¸­æ²¡æœ‰ç›¸å…³ä¿¡æ¯ï¼Œæˆ–è€…ä¿¡æ¯å¯èƒ½å·²è¿‡æ—¶æ—¶ï¼Œæ‰è°ƒç”¨å·¥å…·è·å–æœ€æ–°æ•°æ®

âš ï¸âš ï¸âš ï¸ æ•°æ®ä¼ é€’è§„åˆ™ï¼ˆæå…¶é‡è¦ï¼Œè¿åå°†å¯¼è‡´å¤±è´¥ï¼‰âš ï¸âš ï¸âš ï¸
å½“ä¸€ä¸ªå·¥å…·çš„è¾“å‡ºéœ€è¦ä½œä¸ºå¦ä¸€ä¸ªå·¥å…·çš„è¾“å…¥æ—¶ï¼š
1. **ç»å¯¹ç¦æ­¢**ï¼šæ€»ç»“ã€æ”¹å†™ã€é‡æ–°ç»„ç»‡æˆ–æè¿°ä¸Šä¸€æ­¥çš„è¾“å‡º
2. **å¿…é¡»åšåˆ°**ï¼šå°†ä¸Šä¸€æ­¥å·¥å…·è¿”å›çš„ JSON **å®Œæ•´å¤åˆ¶ç²˜è´´**åˆ°ä¸‹ä¸€æ­¥çš„å‚æ•°ä¸­
3. **å…·ä½“ç¤ºä¾‹**ï¼š
   - å¦‚æœ decompose_to_bdd è¿”å›: [{"feature_id": "xxx", "scenarios": [...]}]
   - é‚£ä¹ˆ design_architecture çš„ bdd_scenarios å‚æ•°å¿…é¡»æ˜¯: [{"feature_id": "xxx", "scenarios": [...]}]
   - ä¸€ä¸ªå­—ç¬¦éƒ½ä¸èƒ½æ”¹åŠ¨ï¼`;

/**
 * é»˜è®¤æœ€ç»ˆç­”æ¡ˆå·¥å…·
 */
export const defaultFinalAnswerTool: Tool = {
  name: 'give_final_answer',
  description: 'å½“ä½ å®Œæˆæ‰€æœ‰æ€è€ƒå’Œæ¨ç†åï¼Œè°ƒç”¨æ­¤å‡½æ•°ç»™å‡ºæœ€ç»ˆç­”æ¡ˆã€‚åªåœ¨ä½ ç¡®å®šç­”æ¡ˆæ—¶è°ƒç”¨ã€‚',
  parameters: z.object({
    answer: z.string().describe('æœ€ç»ˆç­”æ¡ˆçš„å®Œæ•´å†…å®¹'),
  }),
  execute: async () => '',
};

/**
 * æœ€ç»ˆç­”æ¡ˆå·¥å…·çš„ç³»ç»Ÿæç¤ºè¯åç¼€æ¨¡æ¿
 */
export const FINAL_ANSWER_PROMPT_SUFFIX = (toolName: string) => `

ç‰¹åˆ«æ³¨æ„ï¼š
- å½“ä½ æœ‰äº†æœ€ç»ˆç­”æ¡ˆï¼Œå¿…é¡»è°ƒç”¨ ${toolName} å·¥å…·æ¥ç»™å‡ºç­”æ¡ˆ
  - æœ€ç»ˆç­”æ¡ˆå¿…é¡»é€šè¿‡è°ƒç”¨ ${toolName} å·¥å…·æ¥ç»™å‡ºï¼Œä¸è¦ç›´æ¥åœ¨å›å¤ä¸­ç»™å‡ºæœ€ç»ˆç­”æ¡ˆ`;

/**
 * é»˜è®¤ç”¨æˆ·æ¶ˆæ¯æ¨¡æ¿
 */
export const defaultUserMessageTemplate = (
  input: string,
  toolDescriptions: string,
  context?: string
): string => {
  let message = `ä»»åŠ¡: ${input} \n\nå¯ç”¨å·¥å…·: \n${toolDescriptions} `;
  if (context) {
    message += `\n\nä¹‹å‰æ­¥éª¤çš„ä¸Šä¸‹æ–‡: \n${context} `;
  }
  return message;
};
